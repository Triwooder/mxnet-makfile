
# mxnet 中的 Makefile

## 变量

### 变量的定义与赋值

可以使用 `define ... endef` 的形式定义变量，变量值初始化为空：

``` makefile
define <variable>
endef
```

也可以直接对变量进行赋值，省略定义过程。有四种赋值方式：

| 赋值方式 | 符号 | 说明                                                         |
| -------- | ---- | ------------------------------------------------------------ |
| 宏赋值   | `=`  | 直接将右侧表达式的规则赋值给变量                             |
| 简单赋值 | `:=` | 类似于程序语言中的赋值方式，计算出右侧表达式的值，赋值给变量 |
| 条件赋值 | `?=` | 如果当前变量被定义过，则变量值不会被改变                     |
| 追加赋值 | `+=` | 类似字符串拼接                                               |

### 变更量的使用

使用符号 `$(<variable>)` 或者 `${<variable>}` 来取变量的内容，类似于 C 语言中的宏。

### 自动化变量

| 变量    | 作用                                                         |
| ------- | ------------------------------------------------------------ |
| `$@`    | 目标文件集                                                   |
| `$%`    | 目标成员名（需要目标是函数库文件，否则值为空）               |
| `$^`    | 所有依赖文件（去重）                                         |
| `$<`    | 第一个依赖文件。如果依赖是模式定义的（即 `%`），则匹配符合模式的依赖文件集 |
| `$?`    | 比目标文件新的依赖文件，以空格分隔                           |
| `$+`    | 所有依赖文件（不去重）                                       |
| `$*`    | 目标模式中 `%` 及其之前的部分                                |
| `$(@D)` | `$@` 的路径部分（`$@` 替换成以上任何自动化变量同理）         |
| `$(@F)` | `$@` 的文件部分（`$@` 替换成以上任何自动化变量同理）         |

## 函数

### mxnet/Makefile 文件中出现过的函数

| 函数名称     | 使用方式                       | 说明                                        |
| ------------ | ------------------------------ | ------------------------------------------- |
| `shell`      | `shell <commands>`             | 生成 shell 程序来执行命令，<br>返回命令输出 |
| `wildcard`   | `wildcard <pattern>`           | 返回符合模式的所有文件名称                  |
| `warning`    | `warning <text>`               | 以 warning 的形式打印文本                   |
| `error`      | `error <text>`                 | 以 error 的形式打印文本，停止编译           |
| `info`       | `info <text>`                  | 直接打印文本                                |
| `filter`     | `filter  <pattern>, <text>`    | 保留文本中符合模式的所有单词                |
| `filter-out` | `filter-out <pattern>, <text>` | 去除文本中符合模式的所有单词                |

### 函数的使用

与变量的使用类似，使用符号 `$(<function> <argument>)` 或 `${<function> <argument>}` 调用函数。

## Makefile 规则

```makefile
<targets>: <prerequisites>
	<commands>
```

通过比较目标文件 `<targets>` 与依赖文件 `<prerequisites>` 的修改时间，如果依赖文件较新，则需要通过运行 `<commands>` 文件中的命令更新目标文件。

一个 Makefile 文件会有多个类似的目标文件及其依赖形成的代码块，其中在 Makefile 文件中第一个出现的目标文件为默认目标，生成依赖时以该目标为起点，递归形式地生成其依赖项。

### 伪目标

```makefile
.PHONY: <pseudo-targets>
<pseudo-targets>:
	<commands>
```

我们不会为伪目标生成文件，伪目标只是一个标签，用于在出现时执行其下的命令。但也可以为伪目标至顶依赖文件，甚至将伪目标放在第一个时，同样可以成为默认目标，可以用于一次性生成若干个可执行文件。

```makefile
.PHONY: all

all: <target1> <target2> <target3>

<target1>: <prerequisites1>
	<commands1>
	
<target2>: <prerequisites2>
	<commands2>
	
<target3>: <prerequisites3>
	<commands3>
```

## 命令依赖

正常情况下，我们执行 `<commands>` 中的命令，就会使得目标文件重新生成。但优势我们需要执行某些命令，但不引起目标被重新生成，就需要使用命令依赖项。

```makefile
<target>: <normal prerequisites> | <order-only prerequisites>
	<commands>
```

在 mxnet 中，命令依赖项出现了一次，且为伪目标。不确定可不可以是普通依赖文件。